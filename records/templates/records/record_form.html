{% extends 'base.html' %}

{% block title %}{% if form.instance.id %}Editar{% else %}Novo{% endif %} Registro{% endblock %}

{% block content %}
<div class="row mb-4">
  <div class="col">
    <h2>{% if form.instance.id %}Editar{% else %}Novo{% endif %} Registro</h2>
  </div>
</div>

<div class="card">
  <div class="card-body">
    <form method="post">
      {% csrf_token %}
      
      <div class="mb-3">
        <label for="{{ form.category.id_for_label }}" class="form-label">Categoria</label>
        {{ form.category }}
        {% if form.category.errors %}
        <div class="invalid-feedback d-block">
          {{ form.category.errors }}
        </div>
        {% endif %}
      </div>
      
      <div class="mb-3">
        <label for="{{ form.product.id_for_label }}" class="form-label">Produto</label>
        {{ form.product }}
        {% if form.product.errors %}
        <div class="invalid-feedback d-block">
          {{ form.product.errors }}
        </div>
        {% endif %}
      </div>
      
      <div class="mb-3">
        <label for="{{ form.weight.id_for_label }}" class="form-label">Peso (kg)</label>
        {{ form.weight }}
        {% if form.weight.errors %}
        <div class="invalid-feedback d-block">
          {{ form.weight.errors }}
        </div>
        {% endif %}
      </div>
      
      <div class="mb-3">
        <label for="{{ form.value.id_for_label }}" class="form-label">Valor (R$)</label>
        {{ form.value }}
        {% if form.value.errors %}
        <div class="invalid-feedback d-block">
          {{ form.value.errors }}
        </div>
        {% endif %}
      </div>
      
      <div class="mb-3">
        <label for="{{ form.is_entry.id_for_label }}" class="form-label">Tipo</label>
        {{ form.is_entry }}
        {% if form.is_entry.errors %}
        <div class="invalid-feedback d-block">
          {{ form.is_entry.errors }}
        </div>
        {% endif %}
      </div>
      
      <div class="d-flex justify-content-between">
        <a href="{% url 'record_list' %}" class="btn btn-secondary">Cancelar</a>
        <button type="submit" class="btn btn-primary">Salvar</button>
      </div>
    </form>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const categorySelect = document.getElementById('id_category');
    const productSelect = document.getElementById('id_product');
    const weightInput = document.getElementById('id_weight');
    const valueInput = document.getElementById('id_value');
    const isEntrySelect = document.getElementById('id_is_entry');
    let pricePerKg = 0;

    function filterProducts() {
      const categoryId = categorySelect.value;
      fetch(`/products/api/by_category/${categoryId}/`)
        .then(response => response.json())
        .then(data => {
          productSelect.innerHTML = '';
          data.forEach(function(product) {
            const option = document.createElement('option');
            option.value = product.id;
            option.text = product.title;
            productSelect.appendChild(option);
          });
        });
      // Buscar preço por quilo do resíduo
      fetch(`/prices/api/by_category/${categoryId}/`)
        .then(response => response.json())
        .then(data => {
          pricePerKg = data.value || 0;
          updateValue();
        });
    }
    function updateValue() {
      const weight = parseFloat(weightInput.value) || 0;
      valueInput.value = (weight * pricePerKg).toFixed(2);
    }
    if (categorySelect) {
      categorySelect.addEventListener('change', filterProducts);
      filterProducts();
    }
    if (weightInput) {
      weightInput.addEventListener('input', updateValue);
    }
    if (isEntrySelect) {
      isEntrySelect.addEventListener('change', updateValue);
    }
  });
</script>
{% endblock %}
